@page "/verifiera-epost"
@using System.Text
@using GylleneDroppen.Core.Entities
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@inject UserManager<User> UserManager
@inject NavigationManager Nav

<PageTitle>Verifiera e-post</PageTitle>

<h3>Verifiering av e-post</h3>

@if (_status != null)
{
    <p>@_status</p>
}

@code {

    [Parameter]
    [SupplyParameterFromQuery(Name = "epost")]
    public string? Email { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "kod")]
    public string? EncodedToken { get; set; }

    private string? _status;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(EncodedToken))
        {
            _status = "❌ Ogiltig verifieringslänk.";
            return;
        }

        var user = await UserManager.FindByEmailAsync(Email);
        if (user == null)
        {
            _status = "❌ Användaren kunde inte hittas.";
            return;
        }

        var decodedToken = Encoding.UTF8.GetString(WebEncoders.Base64UrlDecode(EncodedToken));

        var result = await UserManager.ConfirmEmailAsync(user, decodedToken);
        _status = result.Succeeded
            ? "✅ Din e-post har verifierats! Du kan nu logga in."
            : "❌ Det gick inte att verifiera e-posten. Länken kan ha blivit ogiltig.";
    }

}
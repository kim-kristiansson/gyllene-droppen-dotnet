@page "/whiskies"
@using GylleneDroppen.Application.Interfaces.Services
@using GylleneDroppen.Application.Dtos.Whisky
@using GylleneDroppen.Core.Constants

@inject IWhiskyService WhiskyService
@inject NavigationManager NavigationManager

@rendermode InteractiveServer

<PageTitle>Whiskies</PageTitle>

<div class="whisky-list-container">
    <div class="whisky-list-header">
        <h1>ü•É Whisky Samlingen</h1>
        <a href="/admin/whiskies/skapa" class="btn btn-primary add-whisky-btn">
            <span>‚ûï</span> L√§gg till ny whisky
        </a>
    </div>

    <div class="search-filters">
        <h2>S√∂k och filtrera</h2>

        <div class="search-bar">
            <input type="text" @bind="searchDto.SearchTerm" @onkeypress="HandleKeyPress"
                   placeholder="S√∂k p√• namn, destilleri eller region..." class="search-input">
            <div class="search-actions">
                <button @onclick="SearchWhiskies" class="btn btn-primary">S√∂k</button>
                <button @onclick="ClearSearch" class="btn btn-secondary">Rensa</button>
            </div>
        </div>

        <div class="filter-grid">
            <div class="filter-group">
                <label>Land:</label>
                <select @bind="searchDto.Country">
                    <option value="">Alla l√§nder</option>
                    @foreach (var country in WhiskyConstants.Countries)
                    {
                        <option value="@country">@country</option>
                    }
                </select>
            </div>

            <div class="filter-group">
                <label>Region:</label>
                <select @bind="searchDto.Region">
                    <option value="">Alla regioner</option>
                    @foreach (var region in WhiskyConstants.CommonRegions)
                    {
                        <option value="@region">@region</option>
                    }
                </select>
            </div>

            <div class="filter-group">
                <label>Typ:</label>
                <select @bind="searchDto.Type">
                    <option value="">Alla typer</option>
                    @foreach (var type in WhiskyConstants.WhiskyTypes)
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
        </div>

        <div class="range-filters">
            <div class="range-group">
                <label>√Ölder fr√•n:</label>
                <input type="number" @bind="searchDto.MinAge" min="0" max="100">
                <label>till:</label>
                <input type="number" @bind="searchDto.MaxAge" min="0" max="100">
            </div>

            <div class="range-group">
                <label>ABV fr√•n:</label>
                <input type="number" @bind="searchDto.MinAbv" min="0" max="100" step="0.1">
                <label>till:</label>
                <input type="number" @bind="searchDto.MaxAbv" min="0" max="100" step="0.1">
            </div>

            <div class="range-group">
                <label>Pris fr√•n:</label>
                <input type="number" @bind="searchDto.MinPrice" min="0" step="0.01">
                <label>till:</label>
                <input type="number" @bind="searchDto.MaxPrice" min="0" step="0.01">
            </div>
        </div>

        <div class="sort-controls">
            <label>Sortera efter:</label>
            <select @bind="searchDto.SortBy">
                <option value="Name">Namn</option>
                <option value="Age">√Ölder</option>
                <option value="Abv">ABV</option>
                <option value="Price">Pris</option>
                <option value="CreatedDate">Datum tillagt</option>
            </select>

            <div class="sort-checkbox">
                <input type="checkbox" @bind="searchDto.SortDescending" id="sortDesc">
                <label for="sortDesc">Fallande</label>
            </div>

            <button @onclick="SearchWhiskies" class="btn btn-primary">Filtrera</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            Laddar whiskies...
        </div>
    }
    else if (searchResult?.Whiskies.Any() == true)
    {
        <div class="results-info">
            <div class="results-count">
                Visar @searchResult.Whiskies.Count av @searchResult.TotalCount whiskies
            </div>

            @if (searchResult.TotalPages > 1)
            {
                <div class="pagination">
                    <button @onclick="() => GoToPage(searchDto.Page - 1)" disabled="@(!searchResult.HasPreviousPage)">
                        F√∂reg√•ende
                    </button>

                    <span class="page-info">Sida @searchResult.Page av @searchResult.TotalPages</span>

                    <button @onclick="() => GoToPage(searchDto.Page + 1)" disabled="@(!searchResult.HasNextPage)">
                        N√§sta
                    </button>
                </div>
            }
        </div>

        <div class="whisky-grid">
            @foreach (var whisky in searchResult.Whiskies)
            {
                <div class="whisky-card">
                    <div class="whisky-image">
                        @if (!string.IsNullOrEmpty(whisky.ImagePath))
                        {
                            <img src="@whisky.ImagePath" alt="@whisky.Name">
                        }
                        else
                        {
                            <div class="whisky-image-placeholder">ü•É</div>
                        }
                    </div>

                    <div class="whisky-info">
                        <h3 class="whisky-name">@whisky.Name</h3>
                        
                        <div class="whisky-details">
                            <div class="whisky-detail"><strong>Destilleri:</strong> @whisky.Distillery</div>
                            <div class="whisky-detail"><strong>Land:</strong> @whisky.Country</div>
                            <div class="whisky-detail"><strong>Region:</strong> @whisky.Region</div>
                            <div class="whisky-detail"><strong>Typ:</strong> @whisky.Type</div>
                            @if (whisky.BottleSize.HasValue)
                            {
                                <div class="whisky-detail"><strong>Flaskstorlek:</strong> @whisky.BottleSize ml</div>
                            }
                        </div>

                        <div class="whisky-highlight">
                            <div class="whisky-age">
                                @if (whisky.Age.HasValue)
                                {
                                    <span>@whisky.Age √•rs</span>
                                }
                                else
                                {
                                    <span>NAS</span>
                                }
                            </div>
                            <div class="whisky-abv">@whisky.Abv% ABV</div>
                            @if (whisky.Price.HasValue)
                            {
                                <div class="whisky-price">@whisky.Price.Value.ToString("C")</div>
                            }
                        </div>

                        <div class="tasting-count">
                            Provad @whisky.TastingCount g√•ng@(whisky.TastingCount != 1 ? "er" : "")
                        </div>

                        <div class="whisky-actions">
                            <button @onclick="() => ViewWhisky(whisky.Id)" class="btn-view-details">
                                Visa detaljer
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (searchResult.TotalPages > 1)
        {
            <div class="pagination" style="justify-content: center; margin-top: 2rem;">
                <button @onclick="() => GoToPage(searchDto.Page - 1)" disabled="@(!searchResult.HasPreviousPage)">
                    F√∂reg√•ende
                </button>

                <span class="page-info">Sida @searchResult.Page av @searchResult.TotalPages</span>

                <button @onclick="() => GoToPage(searchDto.Page + 1)" disabled="@(!searchResult.HasNextPage)">
                    N√§sta
                </button>
            </div>
        }
    }
    else if (searchResult != null)
    {
        <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <h3>Inga whiskies hittades</h3>
            <p>Inga whiskies matchade dina s√∂kkriterier. Prova att justera filtren eller s√∂ktermen.</p>
            <button @onclick="ClearSearch" class="btn btn-primary">Rensa alla filter</button>
        </div>
    }
</div>

@code {
    private WhiskySearchDto searchDto = new();
    private WhiskySearchResultDto? searchResult;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await SearchWhiskies();
    }

    private async Task SearchWhiskies()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            searchResult = await WhiskyService.SearchWhiskiesAsync(searchDto);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching whiskies: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearSearch()
    {
        searchDto = new WhiskySearchDto();
        await SearchWhiskies();
    }

    private async Task GoToPage(int page)
    {
        searchDto.Page = page;
        await SearchWhiskies();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchWhiskies();
        }
    }

    private void ViewWhisky(Guid whiskyId)
    {
        NavigationManager.NavigateTo($"/whiskies/{whiskyId}");
    }

}